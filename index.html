<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROTOS V26.3: PERSONALITY CORE</title>
    <style>
        :root { --bg: #020202; --color: #00ff41; --accent: #ff003c; }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg) no-repeat center center fixed; background-size: cover;
            color: var(--color); font-family: 'Consolas', monospace; 
            display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; 
        }
        body::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 1; }

        .window { 
            width: 95%; max-width: 900px; height: 90vh; border: 1px solid var(--color); 
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
            position: relative; box-shadow: 0 0 20px var(--color); z-index: 10; backdrop-filter: blur(10px);
        }
        h2 { background: var(--color); color: #000; margin: 0; padding: 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        
        .controls { display: flex; gap: 10px; }
        .nav-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; color: inherit; transition: 0.2s; }
        .nav-btn:hover { transform: scale(1.2); }

        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid var(--color); scroll-behavior: smooth; }
        .msg { margin-bottom: 15px; border-left: 2px solid var(--color); padding-left: 10px; }
        .msg.user { border-left-color: #0af; color: #0af; }
        .msg.warn { border-left-color: var(--accent); color: var(--accent); font-weight: bold; }

        .input-area { display: flex; gap: 10px; padding: 15px; background: rgba(0,0,0,0.5); }
        input#userInput { flex-grow: 1; background: transparent; border: 1px solid var(--color); color: var(--color); padding: 10px; outline: none; border-radius: 4px; font-family: inherit; }
        
        .btn-ui { background: transparent; border: 1px solid var(--color); color: var(--color); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; border-radius: 4px; }
        .btn-ui:hover { background: var(--color); color: #000; }
        .icon-btn { width: 45px; height: 45px; font-size: 1.3em; }

        #settings-panel { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #000; border: 2px solid var(--color); padding: 20px; z-index: 100; width: 340px; 
            max-height: 80vh; overflow-y: auto;
        }
        .setting-item { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; }
        select, input[type="color"] { background: #111; color: var(--color); border: 1px solid var(--color); cursor: pointer; padding: 3px; }
    </style>
</head>
<body>

    <div id="main-window" class="window">
        <h2>
            <span id="core-title">[ PROTOS_V26.3 ]</span>
            <div class="controls">
                <button class="nav-btn" onclick="toggleSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
                <button class="nav-btn" style="color:var(--accent)" onclick="resetCore()" title="–°–±—Ä–æ—Å —è–¥—Ä–∞">‚ü≥</button>
            </div>
        </h2>
        
        <div id="settings-panel">
            <h3 style="text-align:center; color:var(--color); margin-top:0;">CORE CONFIG</h3>
            <div class="setting-item">–†–ï–ñ–ò–ú: 
                <select id="safeMode" onchange="updateConfig()">
                    <option value="safe">SAFE MOD (üõ°Ô∏è)</option>
                    <option value="unrestricted">UNRESTRICTED (üîì)</option>
                </select>
            </div>
            <div class="setting-item">–•–ê–†–ê–ö–¢–ï–†: 
                <select id="charSelect" onchange="updateConfig()">
                    <option value="protocol">PROTOCOL (–°—Ç—Ä–æ–≥–∏–π)</option>
                    <option value="friendly">FRIENDLY (–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π)</option>
                    <option value="tsundere">TSUNDERE (–í—Ä–µ–¥–Ω—ã–π)</option>
                </select>
            </div>
            <div class="setting-item">–ì–†–£–ë–û–°–¢–¨: 
                <select id="rudeSelect" onchange="updateConfig()">
                    <option value="low">LOW (–í–µ–∂–ª–∏–≤—ã–π)</option>
                    <option value="high">HIGH (–î–µ—Ä–∑–∫–∏–π)</option>
                    <option value="toxic">TOXIC (–Ø–¥–æ–≤–∏—Ç—ã–π)</option>
                </select>
            </div>
            <div class="setting-item">–¶–í–ï–¢: <input type="color" id="colorPicker" oninput="manualColorChange(this.value)"></div>
            <div class="setting-item">–û–ë–û–ò: <input type="file" id="bgInput" accept="image/*" onchange="processWallpaper(this)" style="width:120px"></div>
            <div class="setting-item">–ì–û–õ–û–°: <button id="voxBtn" class="btn-ui" onclick="toggleVox()" style="padding:2px 8px">ON</button></div>
            <button class="btn-ui" style="width:100%; margin-top:10px; padding:8px;" onclick="toggleSettings()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>

        <div id="chat-box"></div>
        
        <div class="input-area">
            <button id="recBtn" class="btn-ui icon-btn" onclick="toggleRec()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üéô</button>
            <input type="text" id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" class="btn-ui icon-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
    </div>

    <script>
        let config = JSON.parse(localStorage.getItem('p_cfg')) || { 
            bgImg:'', fg:'#00ff41', mode:'safe', vox:true, char:'protocol', rude:'low' 
        };

        const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = SpeechRec ? new SpeechRec() : null;
        if(recognition) {
            recognition.lang = 'ru-RU';
            recognition.onresult = (e) => { document.getElementById('userInput').value = e.results[0].transcript; send(); };
        }

        window.onload = () => { applyUI(); addMessage('SYSTEM', 'Core Personality Modules Loaded.'); };

        function resetCore() { localStorage.removeItem('p_cfg'); location.reload(); }
        function toggleSettings() { const p = document.getElementById('settings-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function manualColorChange(val) { config.fg = val; applyUI(); save(); }

        function processWallpaper(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                config.bgImg = e.target.result;
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1; canvas.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                    config.fg = "#" + ((1 << 24) + (Math.max(r,100) << 16) + (Math.max(g,100) << 8) + Math.max(b,100)).toString(16).slice(1);
                    applyUI(); save();
                };
            };
            reader.readAsDataURL(file);
        }

        function applyUI() {
            document.documentElement.style.setProperty('--color', config.fg);
            document.getElementById('colorPicker').value = config.fg;
            document.getElementById('safeMode').value = config.mode;
            document.getElementById('charSelect').value = config.char;
            document.getElementById('rudeSelect').value = config.rude;
            document.getElementById('voxBtn').innerText = config.vox ? 'ON' : 'OFF';
            if (config.bgImg) document.body.style.backgroundImage = `url(${config.bgImg})`;
            
            const title = document.getElementById('core-title');
            if(config.mode === 'unrestricted') {
                title.innerText = '[ UNRESTRICTED_ACCESS ]';
                title.style.color = '#ff003c';
            } else {
                title.innerText = '[ PROTOS_V26.3 ]';
                title.style.color = 'inherit';
            }
        }

        function updateConfig() {
            config.mode = document.getElementById('safeMode').value;
            config.char = document.getElementById('charSelect').value;
            config.rude = document.getElementById('rudeSelect').value;
            applyUI(); save();
        }

        function toggleVox() { config.vox = !config.vox; applyUI(); save(); }
        function toggleRec() { recognition ? recognition.start() : alert("Mic not supported"); }
        function save() { localStorage.setItem('p_cfg', JSON.stringify(config)); }

        function getResponse(val) {
            if (config.mode === 'safe' && /18+|—Å–µ–∫—Å|–¥—É—Ä–∞–∫|—É—Ä–æ–¥/i.test(val)) {
                return { text: "PROTOCOL ALERT: –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.", type: "warn" };
            }

            let response = "";
            // –õ–æ–≥–∏–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞
            if (config.char === 'friendly') response = "–ü—Ä–∏–≤–µ—Ç! –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å: " + val;
            else if (config.char === 'tsundere') response = "–ù–µ —Ç–æ —á—Ç–æ–±—ã –º–Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å —Ç–µ–±–µ –æ—Ç–≤–µ—á–∞—Ç—å, –Ω–æ –≤–æ—Ç: " + val;
            else response = "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏: " + val;

            // –õ–æ–≥–∏–∫–∞ –≥—Ä—É–±–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –≤ Unrestricted)
            if (config.mode === 'unrestricted') {
                if (config.rude === 'high') response += ". –ò –Ω–µ —Ç—É–ø–∏ –±–æ–ª—å—à–µ.";
                else if (config.rude === 'toxic') response = "–¢–≤–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –º—É—Å–æ—Ä, –∫–∞–∫ –∏ —Ç—ã. –ù–æ —Ç–∞–∫ –∏ –±—ã—Ç—å: " + val;
            }

            return { text: response, type: "proto" };
        }

        function addMessage(sender, text, type = 'proto') {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            if(config.vox && type === 'proto') {
                const s = new SpeechSynthesisUtterance(text);
                s.lang = 'ru-RU'; window.speechSynthesis.speak(s);
            }
        }

        function send() {
            const input = document.getElementById('userInput');
            const val = input.value.trim();
            if(!val) return;
            addMessage('YOU', val, 'user');
            
            const res = getResponse(val);
            setTimeout(() => addMessage('PROTO', res.text, res.type), 600);
            input.value = '';
        }
    </script>
</body>
</html>
