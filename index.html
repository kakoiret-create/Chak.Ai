<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROTOS V26.3: VOICE CLONE</title>
    <style>
        :root { --bg: #020202; --color: #00ff41; --accent: #ff003c; }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg) no-repeat center center fixed; background-size: cover;
            color: var(--color); font-family: 'Consolas', monospace; 
            display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; 
        }
        body::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.7); z-index: 1; }

        .window { 
            width: 95%; max-width: 900px; height: 90vh; border: 1px solid var(--color); 
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column; 
            position: relative; box-shadow: 0 0 20px var(--color); z-index: 10; backdrop-filter: blur(10px);
        }
        h2 { background: var(--color); color: #000; margin: 0; padding: 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        
        .controls { display: flex; gap: 10px; }
        .nav-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; color: inherit; }

        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid var(--color); }
        .msg { margin-bottom: 15px; border-left: 2px solid var(--color); padding-left: 10px; }
        .msg.user { border-left-color: #0af; color: #0af; }

        .input-area { display: flex; gap: 10px; padding: 15px; }
        input#userInput { flex-grow: 1; background: transparent; border: 1px solid var(--color); color: var(--color); padding: 10px; outline: none; }
        
        .btn-ui { background: transparent; border: 1px solid var(--color); color: var(--color); cursor: pointer; border-radius: 4px; padding: 5px 10px; }
        .btn-ui:hover { background: var(--color); color: #000; }

        #settings-panel { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #000; border: 2px solid var(--color); padding: 20px; z-index: 100; width: 360px; 
        }
        .setting-item { margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75em; }
        .voice-viz { width: 100%; height: 30px; background: #111; margin-top: 5px; border: 1px solid #333; position: relative; overflow: hidden; }
        #viz-bar { height: 100%; width: 0%; background: var(--color); transition: 0.1s; }
    </style>
</head>
<body>

    <div id="main-window" class="window">
        <h2>
            <span id="core-title">[ PROTOS_V26.3 ]</span>
            <div class="controls">
                <button class="nav-btn" onclick="toggleSettings()">‚öô</button>
                <button class="nav-btn" style="color:var(--accent)" onclick="resetCore()">‚ü≥</button>
            </div>
        </h2>
        
        <div id="settings-panel">
            <h3 style="text-align:center; color:var(--color); margin: 0 0 15px 0;">ADVANCED CONFIG</h3>
            
            <div style="border: 1px dashed var(--color); padding: 10px; margin-bottom: 15px;">
                <div class="setting-item"><strong>CLONE VOICE:</strong> <button id="cloneBtn" class="btn-ui" onclick="startCloning()">REC SAMPLE</button></div>
                <div class="voice-viz"><div id="viz-bar"></div></div>
                <div id="voiceStatus" style="font-size: 0.6em; margin-top: 5px; color: #888;">No sample saved</div>
            </div>

            <div class="setting-item">–†–ï–ñ–ò–ú: 
                <select id="safeMode" onchange="updateConfig()">
                    <option value="safe">SAFE (üõ°Ô∏è)</option>
                    <option value="unrestricted">UNRESTRICTED (üîì)</option>
                </select>
            </div>
            
            <div class="setting-item">–ì–†–£–ë–û–°–¢–¨: 
                <select id="rudeSelect" onchange="updateConfig()">
                    <option value="low">LOW</option>
                    <option value="high">HIGH</option>
                    <option value="toxic">TOXIC</option>
                </select>
            </div>

            <div class="setting-item">–¶–í–ï–¢: <input type="color" id="colorPicker" oninput="manualColorChange(this.value)"></div>
            <button class="btn-ui" style="width:100%; margin-top:10px;" onclick="toggleSettings()">SAVE & CLOSE</button>
        </div>

        <div id="chat-box"></div>
        
        <div class="input-area">
            <button class="btn-ui" onclick="toggleRec()">üéô</button>
            <input type="text" id="userInput" placeholder="–ö–æ–º–∞–Ω–¥–∞..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" class="btn-ui">‚û§</button>
        </div>
    </div>

    <script>
        let config = JSON.parse(localStorage.getItem('p_cfg')) || { 
            fg:'#00ff41', mode:'safe', rude:'low', voicePitch: 1, voiceRate: 1 
        };

        window.onload = () => { applyUI(); addMessage('SYSTEM', 'Voice Cloning Module Ready.'); };

        // --- –õ–û–ì–ò–ö–ê –ö–õ–û–ù–ò–†–û–í–ê–ù–ò–Ø –ì–û–õ–û–°–ê ---
        async function startCloning() {
            const btn = document.getElementById('cloneBtn');
            const status = document.getElementById('voiceStatus');
            const bar = document.getElementById('viz-bar');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                const analyzer = audioContext.createAnalyser();
                source.connect(analyzer);
                
                btn.innerText = "LISTENING...";
                status.innerText = "Speak now: 'Protos, verify my voice pattern'";
                
                let samples = [];
                let startTime = Date.now();
                
                const checkPitch = () => {
                    const data = new Uint8Array(analyzer.frequencyBinCount);
                    analyzer.getByteFrequencyData(data);
                    let volume = data.reduce((a, b) => a + b) / data.length;
                    bar.style.width = Math.min(volume * 2, 100) + "%";
                    
                    if (volume > 10) samples.push(volume);
                    
                    if (Date.now() - startTime < 3000) {
                        requestAnimationFrame(checkPitch);
                    } else {
                        stream.getTracks().forEach(t => t.stop());
                        btn.innerText = "REC SAMPLE";
                        bar.style.width = "0%";
                        finalizeVoice(samples);
                    }
                };
                checkPitch();
            } catch (e) { alert("Microphone access denied"); }
        }

        function finalizeVoice(samples) {
            if (samples.length === 0) return;
            const avg = samples.reduce((a,b) => a+b) / samples.length;
            // –ò–º–∏—Ç–∞—Ü–∏—è "–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è": –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É (pitch) –ø–æ–¥ –≥—Ä–æ–º–∫–æ—Å—Ç—å/—á–∞—Å—Ç–æ—Ç—É
            config.voicePitch = (avg / 30).toFixed(1); 
            if (config.voicePitch < 0.5) config.voicePitch = 0.5;
            if (config.voicePitch > 2) config.voicePitch = 2;
            
            document.getElementById('voiceStatus').innerText = `Voice Pattern Saved: Pitch ${config.voicePitch}`;
            save();
            
            const synth = window.speechSynthesis;
            const utter = new SpeechSynthesisUtterance("–ì–æ–ª–æ—Å–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –¢–µ–ø–µ—Ä—å —è –≥–æ–≤–æ—Ä—é –∫–∞–∫ —Ç—ã.");
            utter.pitch = config.voicePitch;
            utter.lang = 'ru-RU';
            synth.speak(utter);
        }

        // --- –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò ---
        function toggleSettings() { const p = document.getElementById('settings-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
        function manualColorChange(v) { config.fg = v; applyUI(); save(); }
        function save() { localStorage.setItem('p_cfg', JSON.stringify(config)); }
        function resetCore() { localStorage.removeItem('p_cfg'); location.reload(); }

        function applyUI() {
            document.documentElement.style.setProperty('--color', config.fg);
            document.getElementById('safeMode').value = config.mode;
            document.getElementById('rudeSelect').value = config.rude;
            if(config.voicePitch !== 1) document.getElementById('voiceStatus').innerText = `Pattern Active: Pitch ${config.voicePitch}`;
        }

        function updateConfig() {
            config.mode = document.getElementById('safeMode').value;
            config.rude = document.getElementById('rudeSelect').value;
            applyUI(); save();
        }

        function addMessage(sender, text, type = 'proto') {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;

            if(type === 'proto') {
                const s = new SpeechSynthesisUtterance(text);
                s.lang = 'ru-RU';
                s.pitch = config.voicePitch; // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ "–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ" –ø–∏—Ç—á–∞
                window.speechSynthesis.speak(s);
            }
        }

        function send() {
            const i = document.getElementById('userInput');
            if(!i.value) return;
            addMessage('YOU', i.value, 'user');
            
            let reply = "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –î–∞–Ω–Ω—ã–µ: " + i.value;
            if (config.mode === 'unrestricted' && config.rude === 'toxic') reply = "–û–ø—è—Ç—å —Ç—ã —Å–æ —Å–≤–æ–µ–π –µ—Ä—É–Ω–¥–æ–π. –°–ª—É—à–∞–π –æ—Ç–≤–µ—Ç: " + i.value;

            setTimeout(() => addMessage('PROTO', reply), 600);
            i.value = '';
        }
    </script>
</body>
</html>
